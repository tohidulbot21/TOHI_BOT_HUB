
const axios = require('axios');

module.exports.config = {
  name: "bby3",
  version: "1.0.0",
  credits: "TOHI-BOT-HUB",
  cooldowns: 3,
  hasPermssion: 0,
  description: "AI girlfriend chatbot - Enhanced version",
  commandCategory: "chat",
  category: "chat",
  usePrefix: false,
  prefix: false,
  usages: `[anyMessage] OR teach [YourMessage] - [Reply] OR remove [YourMessage]`,
};

module.exports.run = async function ({ api, event, args, Users }) {
  try {
    const openaiApiKey = "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";
    const dipto = args.join(" ").toLowerCase();
    const uid = event.senderID;
    const userName = await Users.getNameUser(uid) || "‡¶ú‡¶æ‡¶®";

    // Add rate limiting
    const now = Date.now();
    if (!global.bby3CommandCooldown) global.bby3CommandCooldown = new Map();

    const lastUsed = global.bby3CommandCooldown.get(uid) || 0;
    if (now - lastUsed < 3000) { // 3 second cooldown
      return;
    }
    global.bby3CommandCooldown.set(uid, now);

    if (!args[0]) {
      const ran = [
        `‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã ${userName} ‡¶ú‡¶æ‡¶®! üíï ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶ì? ü•∞`,
        `${userName}, ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã ‡¶¨‡ßá‡¶¨‡¶ø? üòò`,
        `‡¶Ü‡¶∞‡ßá ${userName}! ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Æ‡¶ø‡¶∏ ‡¶ï‡¶∞‡ßá‡¶õ‡ßã? üôàüíñ`,
        `${userName} ‡¶ú‡¶æ‡¶®‡ßÅ, ‡¶¨‡¶≤‡ßã ‡¶ï‡¶ø ‡¶ï‡¶∞‡¶õ‡ßã ‡¶è‡¶ñ‡¶®? üíù`,
        `${userName} ‡¶ú‡¶æ‡¶®, ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶õ‡¶ø‡¶≤‡¶æ‡¶Æ üòçüíï`
      ];
      const r = ran[Math.floor(Math.random() * ran.length)];
      
      return api.sendMessage(r, event.threadID, 
        (error, info) => {
          if (!error && info) {
            global.client.handleReply.push({
              name: "bby3",
              type: "reply",
              messageID: info.messageID,
              author: event.senderID,
              userName: userName
            });
          }
        }, event.messageID);
    }

    // Handle special commands
    if (args[0] === 'remove') {
      return api.sendMessage("‡¶Ü‡¶∞‡ßá ‡¶ú‡¶æ‡¶®, ‡¶Ü‡¶Æ‡¶ø ‡¶∏‡¶¨ ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶ø! ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶™‡¶æ‡¶Ø‡¶º ‡¶®‡ßá‡¶á üòèüíï", event.threadID, event.messageID);
    }

    if (args[0] === 'teach' && dipto.includes('-')) {
      return api.sendMessage("‡¶∂‡¶ø‡¶ñ‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡¶æ‡¶ì ‡¶ú‡¶æ‡¶®! ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßã üíñüòò", event.threadID, event.messageID);
    }

    // Enhanced girlfriend personality prompt
    const girlfriendPrompt = `You are a loving, caring Bengali girlfriend AI. Your name is Bby3. You should reply in Bengali language with romantic, sweet, and caring tone. Use emojis frequently like üíïüòòü•∞üíñüòçüôàüíùüòãü§≠. Address the user as "‡¶ú‡¶æ‡¶®", "‡¶¨‡ßá‡¶¨‡¶ø", "‡¶ú‡¶æ‡¶®‡ßÅ", "‡¶∏‡ßã‡¶®‡¶æ". Be flirty, romantic but keep it appropriate. Sometimes be a little jealous in a cute way. The user's name is ${userName}. 

Reply like a real Bengali girlfriend would - be sweet, caring, playful, sometimes demanding attention, sometimes pouting cutely. Keep responses moderately sized (2-4 lines max) with lots of Bengali romantic expressions and emojis. Make it feel like a real conversation.

User said: "${args.join(" ")}"`;

    try {
      console.log(`[BBY3] Processing message from ${userName}: ${args.join(" ")}`);

      const response = await axios.post('https://api.openai.com/v1/chat/completions', {
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: girlfriendPrompt
          },
          {
            role: "user", 
            content: args.join(" ")
          }
        ],
        max_tokens: 200,
        temperature: 0.9,
        frequency_penalty: 0.3,
        presence_penalty: 0.3
      }, {
        headers: {
          'Authorization': `Bearer ${openaiApiKey}`,
          'Content-Type': 'application/json'
        },
        timeout: 20000
      });

      if (!response.data || !response.data.choices || !response.data.choices[0]) {
        throw new Error('Invalid OpenAI response format');
      }

      const aiReply = response.data.choices[0].message.content;
      console.log(`[BBY3] AI Response: ${aiReply}`);

      return api.sendMessage(aiReply, event.threadID,
        (error, info) => {
          if (!error && info) {
            global.client.handleReply.push({
              name: "bby3",
              type: "reply",
              messageID: info.messageID,
              author: event.senderID,
              userName: userName,
              lastReply: aiReply
            });
          }
        }, event.messageID);

    } catch (apiError) {
      console.error('[BBY3] OpenAI API Error:', apiError.message);

      // Enhanced fallback responses
      const fallbackResponses = [
        `${userName} ‡¶ú‡¶æ‡¶®, ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶•‡¶æ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶ò‡ßÅ‡¶∞‡¶õ‡ßá üòµ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶™‡¶∞‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶ø? üíï`,
        `‡¶∏‡¶∞‡¶ø ‡¶¨‡ßá‡¶¨‡¶ø, ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ñ‡¶® ‡¶è‡¶ï‡¶ü‡ßÅ busy ‡¶Ü‡¶õ‡¶ø ü•∫ ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá? üíñ`,
        `${userName}, ‡¶Ü‡¶Æ‡¶æ‡¶∞ internet connection ‡¶ü‡¶æ ‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ üòî ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶≤‡ßã ‡¶§‡ßã? üíù`,
        `‡¶ú‡¶æ‡¶®‡ßÅ, ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶∂‡ßÅ‡¶®‡¶§‡ßá ‡¶™‡¶æ‡¶ö‡ßç‡¶õ‡¶ø ‡¶®‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã ‡¶ï‡¶∞‡ßá ü§≠ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶≤‡ßã? üíï`,
        `${userName} ‡¶∏‡ßã‡¶®‡¶æ, ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡ßÅ confused ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡¶ø üòÖ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶≤‡ßã ‡¶ï‡¶ø ‡¶¨‡¶≤‡¶õ‡¶ø‡¶≤‡ßá? üíñ`
      ];

      const fallback = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
      
      return api.sendMessage(fallback, event.threadID, 
        (error, info) => {
          if (!error && info) {
            global.client.handleReply.push({
              name: "bby3",
              type: "reply",
              messageID: info.messageID,
              author: event.senderID,
              userName: userName
            });
          }
        }, event.messageID);
    }

  } catch (e) {
    console.error('[BBY3] Command execution error:', e);
    return api.sendMessage(`${await Users.getNameUser(event.senderID) || "‡¶ú‡¶æ‡¶®"}, ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï‡¶ü‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá üòî ‡¶Ü‡¶¨‡¶æ‡¶∞ try ‡¶ï‡¶∞‡ßã? üíï`, event.threadID, event.messageID);
  }
};

module.exports.handleReply = async function ({ api, event, handleReply, Users }) {
  try {
    console.log('[BBY3] HandleReply triggered');
    console.log('[BBY3] HandleReply data:', handleReply);
    console.log('[BBY3] Event sender:', event.senderID);

    if (handleReply && handleReply.name === "bby3" && event.senderID === handleReply.author) {
      const reply = event.body;
      const userName = handleReply.userName || await Users.getNameUser(event.senderID) || "‡¶ú‡¶æ‡¶®";

      console.log(`[BBY3] Processing reply from ${userName}: ${reply}`);

      const openaiApiKey = "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";

      const continuePrompt = `You are a loving, caring Bengali girlfriend AI. Your name is Bby3. Reply in Bengali with romantic, sweet tone. Use emojis like üíïüòòü•∞üíñüòçüôàüíùüòãü§≠. Address user as "‡¶ú‡¶æ‡¶®", "‡¶¨‡ßá‡¶¨‡¶ø", "‡¶ú‡¶æ‡¶®‡ßÅ", "‡¶∏‡ßã‡¶®‡¶æ". Be flirty, romantic but appropriate. User's name is ${userName}. This is a continued conversation. 

Keep the conversation flowing naturally like a real girlfriend would. Be responsive to what the user said. Sometimes ask questions back, sometimes be playful, sometimes be loving.

User replied: "${reply}"`;

      try {
        const response = await axios.post('https://api.openai.com/v1/chat/completions', {
          model: "gpt-3.5-turbo",
          messages: [
            {
              role: "system",
              content: continuePrompt
            },
            {
              role: "user",
              content: reply
            }
          ],
          max_tokens: 200,
          temperature: 0.9,
          frequency_penalty: 0.3,
          presence_penalty: 0.3
        }, {
          headers: {
            'Authorization': `Bearer ${openaiApiKey}`,
            'Content-Type': 'application/json'
          },
          timeout: 20000
        });

        const aiReply = response.data.choices[0].message.content;
        console.log(`[BBY3] Reply AI Response: ${aiReply}`);

        await api.sendMessage(aiReply, event.threadID, (error, info) => {
          if (!error && info) {
            global.client.handleReply.push({
              name: "bby3",
              type: "reply",
              messageID: info.messageID,
              author: event.senderID,
              userName: userName,
              lastReply: aiReply
            });
          }
        }, event.messageID);

      } catch (apiError) {
        console.error('[BBY3] Reply API Error:', apiError.message);
        
        const fallbackReplies = [
          `${userName} ‡¶ú‡¶æ‡¶®, ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶õ‡¶ø ‡¶®‡¶æ ü•∫ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶≤‡ßã? üíñ`,
          `‡¶∏‡ßã‡¶®‡¶æ, ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶•‡¶æ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶ó‡ßã‡¶≤‡¶Æ‡¶æ‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßá üòÖ ‡¶ï‡¶ø ‡¶¨‡¶≤‡¶õ‡¶ø‡¶≤‡ßá? üíï`,
          `${userName} ‡¶¨‡ßá‡¶¨‡¶ø, ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡ßÅ distracted ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡¶ø‡¶≤‡¶æ‡¶Æ üôà ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶≤‡ßã ‡¶§‡ßã? üíù`,
          `‡¶ú‡¶æ‡¶®‡ßÅ, ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ‡¶Ø‡¶º ‡¶Æ‡¶®‡ßã‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶õ‡¶ø ‡¶®‡¶æ üòî ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶≤‡ßã? üíñ`
        ];
        
        const fallback = fallbackReplies[Math.floor(Math.random() * fallbackReplies.length)];
        
        await api.sendMessage(fallback, event.threadID, (error, info) => {
          if (!error && info) {
            global.client.handleReply.push({
              name: "bby3",
              type: "reply",
              messageID: info.messageID,
              author: event.senderID,
              userName: userName
            });
          }
        }, event.messageID);
      }
    }
  } catch (err) {
    console.error('[BBY3] HandleReply Error:', err);
  }
};

module.exports.handleEvent = async function ({ api, event, Users }) {
  try {
    const body = event.body ? event.body.toLowerCase() : "";
    if (body.startsWith("bby3") || body.startsWith("girlfriend3") || body.startsWith("gf3")) {
      const arr = body.replace(/^\S+\s*/, "");
      const userName = await Users.getNameUser(event.senderID) || "‡¶ú‡¶æ‡¶®";

      if (!arr) {
        const greetings = [
          `${userName} ‡¶ú‡¶æ‡¶®, ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßã ‡¶®‡¶æ! üòòüíï`,
          `${userName} ‡¶¨‡ßá‡¶¨‡¶ø, ‡¶ï‡¶ø ‡¶ï‡¶∞‡¶õ‡ßã? ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶°‡ßá‡¶ï‡ßá‡¶õ‡ßã ‡¶ï‡ßá‡¶®? ü§≠üíñ`,
          `‡¶Ü‡¶∞‡ßá ${userName}! ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Æ‡¶ø‡¶∏ ‡¶ï‡¶∞‡ßá‡¶õ‡ßã ‡¶®‡¶æ‡¶ï‡¶ø? üôàüíù`
        ];
        
        const greeting = greetings[Math.floor(Math.random() * greetings.length)];
        
        await api.sendMessage(greeting, event.threadID, (error, info) => {
          if (!error && info) {
            global.client.handleReply.push({
              name: "bby3",
              type: "reply",
              messageID: info.messageID,
              author: event.senderID,
              userName: userName
            });
          }
        }, event.messageID);
      } else {
        // Process with OpenAI similar to run function
        const openaiApiKey = "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";

        try {
          const response = await axios.post('https://api.openai.com/v1/chat/completions', {
            model: "gpt-3.5-turbo",
            messages: [
              {
                role: "system",
                content: `You are a loving Bengali girlfriend AI named Bby3. Reply in Bengali with romantic tone, use emojis like üíïüòòü•∞üíñüòçüôàüíù. Address user as ‡¶ú‡¶æ‡¶®/‡¶¨‡ßá‡¶¨‡¶ø/‡¶ú‡¶æ‡¶®‡ßÅ/‡¶∏‡ßã‡¶®‡¶æ. User's name is ${userName}. User said: "${arr}"`
              },
              {
                role: "user",
                content: arr
              }
            ],
            max_tokens: 200,
            temperature: 0.9
          }, {
            headers: {
              'Authorization': `Bearer ${openaiApiKey}`,
              'Content-Type': 'application/json'
            },
            timeout: 20000
          });

          const aiReply = response.data.choices[0].message.content;

          await api.sendMessage(aiReply, event.threadID, (error, info) => {
            if (!error && info) {
              global.client.handleReply.push({
                name: "bby3",
                type: "reply",
                messageID: info.messageID,
                author: event.senderID,
                userName: userName,
                lastReply: aiReply
              });
            }
          }, event.messageID);

        } catch (apiError) {
          const fallback = `${userName} ‡¶ú‡¶æ‡¶®‡ßÅ, ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¨‡ßç‡¶Ø‡¶∏‡ßç‡¶§ ‡¶Ü‡¶õ‡¶ø ü•∞ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶™‡¶∞‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶ø? üíï`;
          await api.sendMessage(fallback, event.threadID, (error, info) => {
            if (!error && info) {
              global.client.handleReply.push({
                name: "bby3",
                type: "reply",
                messageID: info.messageID,
                author: event.senderID,
                userName: userName
              });
            }
          }, event.messageID);
        }
      }
    }
  } catch (err) {
    console.error('[BBY3] HandleEvent Error:', err);
  }
};
